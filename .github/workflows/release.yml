name: release

on:
  push:
    tags:
      # Tie releases to a specific Comprehensive Rules effective-date token.
      # Example tag: rules-20260116
      - "rules-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Tag (rules-YYYYMMDD)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "${TAG}" =~ ^rules-[0-9]{8}$ ]]; then
            echo "Expected tag format: rules-YYYYMMDD (got '${TAG}')" >&2
            exit 1
          fi
          TOKEN="${TAG#rules-}"
          echo "RULES_TOKEN=${TOKEN}" >> "${GITHUB_ENV}"
          echo "QDRANT_COLLECTION=mtg_rules_${TOKEN}" >> "${GITHUB_ENV}"
          # Ensure docker-compose runs the CLI container as the GitHub runner user
          # so it can write generated files into the checked-out workspace.
          echo "UID=$(id -u)" >> "${GITHUB_ENV}"
          echo "GID=$(id -g)" >> "${GITHUB_ENV}"

      - name: Resolve Pinned Scryfall Oracle Dataset
        shell: bash
        run: |
          set -euo pipefail
          ORACLE_JSONLD="$(ls -1 resources/scryfall/oracle-cards-*.jsonld.gz 2>/dev/null | sort | tail -n 1 || true)"
          if [ -z "${ORACLE_JSONLD}" ]; then
            echo "No pinned oracle-cards JSON-LD found at resources/scryfall/oracle-cards-*.jsonld.gz" >&2
            exit 1
          fi
          BASENAME="$(basename "${ORACLE_JSONLD}")"
          if [[ ! "${BASENAME}" =~ ^oracle-cards-([0-9]{14})\.jsonld\.gz$ ]]; then
            echo "Could not parse oracle token from filename: ${BASENAME}" >&2
            exit 1
          fi
          ORACLE_TOKEN="${BASH_REMATCH[1]}"
          echo "ORACLE_TOKEN=${ORACLE_TOKEN}" >> "${GITHUB_ENV}"
          echo "ORACLE_JSONLD=${ORACLE_JSONLD}" >> "${GITHUB_ENV}"
          echo "ORACLE_COLLECTION=mtg_oracle_cards_${ORACLE_TOKEN}" >> "${GITHUB_ENV}"

      - name: Start Qdrant
        run: |
          docker compose up -d qdrant
          # Give Qdrant a moment to become ready
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:6333/collections >/dev/null 2>&1; then
              echo "Qdrant ready"; break
            fi
            sleep 1
          done
          curl -fsS http://localhost:6333/collections

      - name: Build Pipeline Image
        run: |
          docker compose build mtg-ontology

      - name: Generate rules SKOS JSON-LD (Pinned To Tag Token)
        run: |
          docker compose run --rm mtg-ontology rules refresh \
            --release-token "${RULES_TOKEN}" \
            --rules-dir resources/MagicCompRules \
            --output resources/mtg/rules.skos.jsonld

      - name: Validate rules SKOS JSON-LD
        run: |
          docker compose run --rm mtg-ontology rules validate \
            --input-jsonld resources/mtg/rules.skos.jsonld

      - name: Upsert rules into Qdrant (OpenAI embeddings)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker compose run --rm mtg-ontology rules upsert-qdrant \
            --input-jsonld resources/mtg/rules.skos.jsonld \
            --collection "${QDRANT_COLLECTION}" \
            --embedding-model text-embedding-3-small

      - name: Snapshot Qdrant collection
        run: |
          docker compose run --rm mtg-ontology qdrant snapshot-collection \
            --collection "${QDRANT_COLLECTION}" \
            --output-dir resources/qdrant-snapshots

      - name: Restore Previous Oracle Cards Snapshot (Best Effort)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          SNAPSHOT="$(python scripts/download_previous_oracle_snapshot.py --output-dir resources/qdrant-snapshots || true)"
          if [ -z "${SNAPSHOT}" ]; then
            echo "no previous oracle snapshot found; will embed from scratch"
            exit 0
          fi
          docker compose run --rm mtg-ontology qdrant recover-snapshot \
            --collection "${ORACLE_COLLECTION}" \
            --snapshot-path "${SNAPSHOT}"
          # Don't re-upload a previous release's snapshot as part of this release.
          rm -f "${SNAPSHOT}"

      - name: Upsert Oracle Cards Into Qdrant (OpenAI embeddings)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker compose run --rm mtg-ontology cards upsert-jsonld \
            --input-jsonld "${ORACLE_JSONLD}" \
            --collection "${ORACLE_COLLECTION}" \
            --embedding-model text-embedding-3-small

      - name: Snapshot Oracle Cards Collection
        run: |
          docker compose run --rm mtg-ontology qdrant snapshot-collection \
            --collection "${ORACLE_COLLECTION}" \
            --output-dir resources/qdrant-snapshots

      - name: Package release assets
        run: |
          mkdir -p dist
          cp -a resources/mtg/rules.skos.jsonld dist/
          cp -a resources/mtg/rules.context.jsonld dist/
          cp -a docs/RULES_SKOS_MODEL.md dist/
          cp -a docs/CODEX_AGENT_GUIDE.md dist/
          cp -a docs/QDRANT_QUERY_GUIDE.md dist/
          cp -a docs/SCRYFALL_JSONLD_MODEL.md dist/
          cp -a resources/scryfall/context.jsonld dist/
          cp -a "${ORACLE_JSONLD}" dist/
          cp -a "resources/MagicCompRules/${RULES_TOKEN}.txt" dist/ || true
          cp -a "resources/MagicCompRules/${RULES_TOKEN}.json" dist/ || true
          # Include snapshot files (may be multiple)
          if [ -d resources/qdrant-snapshots ]; then
            cp -a resources/qdrant-snapshots dist/
          fi
          # Don't write the tarball into the directory being archived; GNU tar will exit 1.
          tarball="mtg_artifacts_${GITHUB_REF_NAME}.tar.gz"
          tar -czf "${tarball}" -C dist .
          mv -f "${tarball}" dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/mtg_artifacts_${{ github.ref_name }}.tar.gz
            dist/rules.skos.jsonld
            dist/rules.context.jsonld
            dist/RULES_SKOS_MODEL.md
            dist/CODEX_AGENT_GUIDE.md
            dist/QDRANT_QUERY_GUIDE.md
            dist/SCRYFALL_JSONLD_MODEL.md
            dist/context.jsonld
            dist/oracle-cards-*.jsonld.gz
            dist/qdrant-snapshots/*
          overwrite_files: true
          fail_on_unmatched_files: true
          generate_release_notes: true
